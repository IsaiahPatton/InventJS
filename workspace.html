<html>
    <title>InventJS - Workspace</title>

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> 
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly@6.20210701.0/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly@6.20210701.0/python_compressed.js"></script>
    <script src="https://unpkg.com/blockly@6.20210701.0/dart_compressed.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify.min.js"></script>
    <script src="https://www.w3schools.com/lib/w3codecolor.js"></script>
    <style>.sc {overflow: auto;} .title * { display:inline-block;min-width:32px; }
    .bord { border:1px solid rgb(180,180,180);border-radius:2px; }
    .btn {background-color:rgb(233,233,237);padding: 2px 4px 2px 4px;border:1px solid rgb(143,143,157);border-radius:5px;cursor:pointer;}
    .btn:hover {background-color:rgb(208,208,215);}
    .w3-gblack{ padding:5px 16px !important;border-bottom: 6px solid rgb(140,190,145) !important;}
    body {background:rgb(230,230,230);} .city,.bbg {background: rgb(247,247,247)}
    </style>

  <div class="w3-container">
    <div class="title">
        <h4 style="background-color:black;color:white;padding:4px;padding-left:8px;padding-right:8px;border-radius:4px;margin-right:1rem;">
            InventJS&trade;
        </h4>
            <span>Saving: <span class="btn" onclick="saveB()">Save</span>&nbsp;
            <span class="btn" onclick="saveBlocks()">Save As...</span>

        </span>
        <span>&nbsp;|&nbsp; <span class="btn" onclick="downloadP('test')">Download Project</span>&nbsp;
            <input type="file" id="files" style="display:none;"/>
<label for="files" class="btn">Load from Download</label>

        </span>
    </div>
    
    <div class="w3-half sc" id="blocklyArea" style="float:left;width:55vw; height:86.5vh;">
        <div id="blocklyDiv" class="sc1 bord"></div>
    </div>
    <div style="position:absolute;bottom:4px;left:1rem;">Credit: Blocky API by Google.</div>

    <div class="" style="width:40vw;display:inline-block;padding-left:1rem;padding-right:1rem;margin-top:-2rem;">
      <div class="w3-bar w3-blak" style="margin:0;padding:0;">
        <span class="w3-bar-item">Code Output: </span>
        <button class="w3-bar-item w3-button tablink w3-gblack" onclick="openCity(event,'djs')">JS</button>
        <button class="w3-bar-item w3-button tablink" onclick="openCity(event,'dpy')">Python</button>
        <button class="w3-bar-item w3-button tablink" onclick="openCity(event,'ddart')">Dart</button>
      </div>

  <div id="djs" class="w3-container w3-border city">
    <div id="textarea" style="height:34vh;padding-top:1rem;" class="jsHigh sc">&nbsp;</div>
  </div>

  <div id="dpy" class="w3-container w3-border city" style="display:none">
    <div id="textpy" style="height:34vh;padding-top:1rem;" class="pythonHigh sc">&nbsp;</div>
  </div>
  
  <div id="ddart" class="w3-container w3-border city" style="display:none">
    <div id="textdart" style="height:34vh;padding-top:1rem;" class="pythonHigh sc">&nbsp;</div>
  </div>
        <div class="title"><h5>Output:</h5> <button onclick="runC()">Run JS</button> </div>
        <div id="output" class="bord bbg" style="height:40vh;padding:8px;">
        </div>
    </div>
    
    <xml id="toolbox" style="display: none">
        <category name="Logic" categorystyle="logic_category">
  <block type="controls_if"></block>
  <block type="logic_compare"></block>
  <block type="logic_operation"></block>
  <block type="logic_negate"></block>
  <block type="logic_boolean"></block>
  <block type="logic_null" disabled="true"></block>
  <block type="logic_ternary"></block>
</category>
<category name="Loops" categorystyle="loop_category">
  <block type="controls_repeat_ext">
    <value name="TIMES">
      <shadow type="math_number">
        <field name="NUM">10</field>
      </shadow>
    </value>
  </block>
  <block type="controls_repeat" disabled="true"></block>
  <block type="controls_whileUntil"></block>
  <block type="controls_for">
    <value name="FROM">
      <shadow type="math_number">
        <field name="NUM">1</field>
      </shadow>
    </value>
    <value name="TO">
      <shadow type="math_number">
        <field name="NUM">10</field>
      </shadow>
    </value>
    <value name="BY">
      <shadow type="math_number">
        <field name="NUM">1</field>
      </shadow>
    </value>
  </block>
  <block type="controls_forEach"></block>
  <block type="controls_flow_statements"></block>
</category>
<category name="Math" categorystyle="math_category">
  <block type="math_number" gap="32">
    <field name="NUM">123</field>
  </block>
  <block type="math_arithmetic">
    <value name="A">
      <shadow type="math_number">
        <field name="NUM">1</field>
      </shadow>
    </value>
    <value name="B">
      <shadow type="math_number">
        <field name="NUM">1</field>
      </shadow>
    </value>
  </block>
  <block type="math_single">
    <value name="NUM">
      <shadow type="math_number">
        <field name="NUM">9</field>
      </shadow>
    </value>
  </block>
  <block type="math_trig">
    <value name="NUM">
      <shadow type="math_number">
        <field name="NUM">45</field>
      </shadow>
    </value>
  </block>
  <block type="math_constant"></block>
  <block type="math_number_property">
    <value name="NUMBER_TO_CHECK">
      <shadow type="math_number">
        <field name="NUM">0</field>
      </shadow>
    </value>
  </block>
  <block type="math_round">
    <value name="NUM">
      <shadow type="math_number">
        <field name="NUM">3.1</field>
      </shadow>
    </value>
  </block>
  <block type="math_on_list"></block>
  <block type="math_modulo">
    <value name="DIVIDEND">
      <shadow type="math_number">
        <field name="NUM">64</field>
      </shadow>
    </value>
    <value name="DIVISOR">
      <shadow type="math_number">
        <field name="NUM">10</field>
      </shadow>
    </value>
  </block>
  <block type="math_constrain">
    <value name="VALUE">
      <shadow type="math_number">
        <field name="NUM">50</field>
      </shadow>
    </value>
    <value name="LOW">
      <shadow type="math_number">
        <field name="NUM">1</field>
      </shadow>
    </value>
    <value name="HIGH">
      <shadow type="math_number">
        <field name="NUM">100</field>
      </shadow>
    </value>
  </block>
  <block type="math_random_int">
    <value name="FROM">
      <shadow type="math_number">
        <field name="NUM">1</field>
      </shadow>
    </value>
    <value name="TO">
      <shadow type="math_number">
        <field name="NUM">100</field>
      </shadow>
    </value>
  </block>
  <block type="math_random_float"></block>
  <block type="math_atan2">
    <value name="X">
      <shadow type="math_number">
        <field name="NUM">1</field>
      </shadow>
    </value>
    <value name="Y">
      <shadow type="math_number">
        <field name="NUM">1</field>
      </shadow>
    </value>
  </block>
</category>
<category name="Text" categorystyle="text_category">
  <block type="text"></block>
  <block type="text_multiline"></block>
  <block type="text_join"></block>
  <block type="text_append">
    <value name="TEXT">
      <shadow type="text"></shadow>
    </value>
  </block>
  <block type="text_length">
    <value name="VALUE">
      <shadow type="text">
        <field name="TEXT">abc</field>
      </shadow>
    </value>
  </block>
  <block type="text_isEmpty">
    <value name="VALUE">
      <shadow type="text">
        <field name="TEXT"></field>
      </shadow>
    </value>
  </block>
  <block type="text_indexOf">
    <value name="VALUE">
      <block type="variables_get">
        <field name="VAR">text</field>
      </block>
    </value>
    <value name="FIND">
      <shadow type="text">
        <field name="TEXT">abc</field>
      </shadow>
    </value>
  </block>
  <block type="text_charAt">
    <value name="VALUE">
      <block type="variables_get">
        <field name="VAR">text</field>
      </block>
    </value>
  </block>
  <block type="text_getSubstring">
    <value name="STRING">
      <block type="variables_get">
        <field name="VAR">text</field>
      </block>
    </value>
  </block>
  <block type="text_changeCase">
    <value name="TEXT">
      <shadow type="text">
        <field name="TEXT">abc</field>
      </shadow>
    </value>
  </block>
  <block type="text_trim">
    <value name="TEXT">
      <shadow type="text">
        <field name="TEXT">abc</field>
      </shadow>
    </value>
  </block>
  <block type="text_count">
    <value name="SUB">
      <shadow type="text"></shadow>
    </value>
    <value name="TEXT">
      <shadow type="text"></shadow>
    </value>
  </block>
  <block type="text_replace">
    <value name="FROM">
      <shadow type="text"></shadow>
    </value>
    <value name="TO">
      <shadow type="text"></shadow>
    </value>
    <value name="TEXT">
      <shadow type="text"></shadow>
    </value>
  </block>
  <block type="text_reverse">
    <value name="TEXT">
      <shadow type="text"></shadow>
    </value>
  </block>
  <label text="Input/Output:" web-class="ioLabel"></label>
  <block type="text_print">
    <value name="TEXT">
      <shadow type="text">
        <field name="TEXT">abc</field>
      </shadow>
    </value>
  </block>
  <block type="text_prompt_ext">
    <value name="TEXT">
      <shadow type="text">
        <field name="TEXT">abc</field>
      </shadow>
    </value>
  </block>
</category>
<category name="Lists" categorystyle="list_category">
  <block type="lists_create_with">
    <mutation items="0"></mutation>
  </block>
  <block type="lists_create_with"></block>
  <block type="lists_repeat">
    <value name="NUM">
      <shadow type="math_number">
        <field name="NUM">5</field>
      </shadow>
    </value>
  </block>
  <block type="lists_length"></block>
  <block type="lists_isEmpty"></block>
  <block type="lists_indexOf">
    <value name="VALUE">
      <block type="variables_get">
        <field name="VAR">list</field>
      </block>
    </value>
  </block>
  <block type="lists_getIndex">
    <value name="VALUE">
      <block type="variables_get">
        <field name="VAR">list</field>
      </block>
    </value>
  </block>
  <block type="lists_setIndex">
    <value name="LIST">
      <block type="variables_get">
        <field name="VAR">list</field>
      </block>
    </value>
  </block>
  <block type="lists_getSublist">
    <value name="LIST">
      <block type="variables_get">
        <field name="VAR">list</field>
      </block>
    </value>
  </block>
  <block type="lists_split">
    <value name="DELIM">
      <shadow type="text">
        <field name="TEXT">,</field>
      </shadow>
    </value>
  </block>
  <block type="lists_sort"></block>
  <block type="lists_reverse"></block>
</category>
<category name="Colour" categorystyle="colour_category">
  <block type="colour_picker"></block>
  <block type="colour_random"></block>
  <block type="colour_rgb">
    <value name="RED">
      <shadow type="math_number">
        <field name="NUM">100</field>
      </shadow>
    </value>
    <value name="GREEN">
      <shadow type="math_number">
        <field name="NUM">50</field>
      </shadow>
    </value>
    <value name="BLUE">
      <shadow type="math_number">
        <field name="NUM">0</field>
      </shadow>
    </value>
  </block>
  <block type="colour_blend">
    <value name="COLOUR1">
      <shadow type="colour_picker">
        <field name="COLOUR">#ff0000</field>
      </shadow>
    </value>
    <value name="COLOUR2">
      <shadow type="colour_picker">
        <field name="COLOUR">#3333ff</field>
      </shadow>
    </value>
    <value name="RATIO">
      <shadow type="math_number">
        <field name="NUM">0.5</field>
      </shadow>
    </value>
  </block>
</category>
<sep></sep>
<category name="Variables" categorystyle="variable_category" custom="VARIABLE">
</category>
<category name="Functions" categorystyle="procedure_category"
custom="PROCEDURE"></category>
            <sep></sep>
      <category name="Custom" colour="255">

        <block type="text"></block>
        <block type="text_print"></block>
        <block type="js_raw"></block>
        <block type="js_elm_by_id"></block>
        <block type="js_create_elm"></block>
        <block type="js_2"></block>
        <block type="js_elm_inner"></block>
      </category>
    </xml>

  </div>
    
    <script>
    var w = 0.99;

    Blockly.Blocks['js_elm_by_id'] = {
      init: function() {
        this.appendValueInput('VALUE')
            .appendField('getElementById')
        this.setOutput(true, 'Number');
        this.setColour(160);
        this.setTooltip('Block form of Javascript\'s "getElementById(id)"');
      }
    };

  Blockly.JavaScript['js_elm_by_id'] = function(block) {
    var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';
    return ['document.getElementById(' + argument0 + ')', document.getElementById(argument0)];
  };
  
      Blockly.Blocks['js_elm_inner'] = {
      init: function() {
        this.appendValueInput('VALUE')
            .appendField('getElementById(')
            //.appendField(new Blockly.Field("myid"),"TEXT")
            this.appendDummyInput('TXT')
                .appendField(').innerHTML');
        this.setInputsInline(true);
        this.setOutput(true, 'Number');
        this.setColour(160);
        this.setTooltip('Block form of Javascript\'s "getElementById(id)"');
      }
    };

  Blockly.JavaScript['js_elm_inner'] = function(block) {
    var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';
    return ['document.getElementById(' + argument0 + ').innerHTML', document.getElementById(argument0)];
  };

    Blockly.Blocks['js_create_elm'] = {
      init: function() {
        this.appendValueInput('VALUE')
            .appendField('createButton')
           // .appendField(new Blockly.FieldTextInput("myid"),"TEXT")
        this.setPreviousStatement(!0);
        this.setNextStatement(!0);
        this.setOutput(0, 'Dummy');
        this.setColour(160);
        this.setTooltip('Add a new Element to the output box');
      }
    };

    Blockly.JavaScript['js_create_elm'] = function(block) {
        //var argument0 = block.getFieldValue('TEXT') || '\'\'';
        var argument0 = Blockly.JavaScript.valueToCode(block, 'VALUE', Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';
        return 'helper_createElement(\'button\', ' + argument0 + ');\n';
    };

    Blockly.Blocks['js_raw'] = {
      init: function() {
        this.appendDummyInput('VALUE')
            .appendField('raw_js')
            .appendField(new Blockly.FieldTextInput("myid"),"TEXT")
        this.setPreviousStatement(!0);
        this.setNextStatement(!0);
        this.setOutput(0, 'Dummy');
        this.setColour(160);
        this.setTooltip('Add a new Element to the output box');
      }
    };

    Blockly.JavaScript['js_raw'] = function(block) {
        var argument0 = block.getFieldValue('TEXT') || '\'\'';
        return argument0 + '\n';
    };


    Blockly.Blocks['js_2'] = {
      init: function() {
        this.appendValueInput('VAL1')
            .appendField('getElementById(');
            this.appendValueInput('VAL2')
            //.appendField(new Blockly.FieldTextInput("myid"),"TEXT")
            .appendField(').innerHTML =');
        this.setInputsInline(true);
        this.setPreviousStatement(!0);
        this.setNextStatement(!0);
        this.setOutput(0, 'Dummy');
        this.setColour(160);
        this.setTooltip('Set the content of an element');
      }
    };
    Blockly.JavaScript['js_2'] = function(block) {
        var argument0 = Blockly.JavaScript.valueToCode(block, 'VAL1', Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';
        var argument1 = Blockly.JavaScript.valueToCode(block, 'VAL2', Blockly.JavaScript.ORDER_FUNCTION_CALL) || '\'\'';
        return 'document.getElementById(' + argument0 + ').innerHTML = ' + argument1 + ";";
    };

var blocklyArea = document.getElementById('blocklyArea');
  var blocklyDiv = document.getElementById('blocklyDiv');
  var workspace = Blockly.inject(blocklyDiv,
      {toolbox: document.getElementById('toolbox')});
  var onresize = function(e) {
    // Compute the absolute coordinates and dimensions of blocklyArea.
    var element = blocklyArea;
    var x = 0;
    var y = 0;
    do {
      x += element.offsetLeft;
      y += element.offsetTop;
      element = element.offsetParent;
    } while (element);
    // Position blocklyDiv over blocklyArea.
    blocklyDiv.style.left = x + 'px';
    blocklyDiv.style.top = y + 'px';
    blocklyDiv.style.width =  (blocklyArea.offsetWidth*(w)) + 'px';
    blocklyDiv.style.height = (blocklyArea.offsetHeight*(w)) + 'px';
    Blockly.svgResize(workspace);
  };
  window.addEventListener('resize', onresize, false);
  onresize();
  Blockly.svgResize(workspace);
  
  function big()   { w += 0.2; onresize(); }
  function small() { w -= 0.2; w = Math.max(0.99,w); onresize(); }

      function myUpdateFunction(event) {
  var code = Blockly.JavaScript.workspaceToCode(workspace);
 
  var spli = code.replaceAll("  ","&nbsp;&nbsp;&nbsp;").split("\n");
  var ta = document.getElementById('textarea');
  document.getElementById('textarea').innerHTML = "";
  for (var i =0; i < spli.length; i++) {
    if (spli[i].length > 0) {
        document.getElementById('textarea').innerHTML += spli[i].replaceAll('[;]', ';<br>') + "<br>";
    }
  }
  
  var demo = "<br>// Auto-generated helper function.<br>" + 
            "function helper_createElement(type, id) {<br>" +
             "&nbsp;&nbsp;&nbsp&nbsp;var btn = document.createElement(type);<br>" + 
             "&nbsp;&nbsp;&nbsp;&nbsp;btn.setAttribute('id', id);<br>" + 
             "&nbsp;&nbsp;&nbsp;&nbsp;document.getElementById('output').appendChild(btn);<br>" + 
             "}";
  if (ta.innerHTML.toString().includes("helper_createElement") && !(ta.innerHTML.toString().includes("function helper_createElement"))) {
    ta.innerHTML += demo;
  }
  
  try {
      var py = Blockly.Python.workspaceToCode(workspace);
      var spli = py.replaceAll("  ","&nbsp;&nbsp;&nbsp;").split("\n");
      document.getElementById('textpy').innerHTML = "";
      for (var i =0; i < spli.length; i++) document.getElementById('textpy').innerHTML += spli[i] + "<br>";
  } catch (error) {
    if (error.toString().indexOf('does not know how to generate code for block type "js_') != -1)
        error = '<b>Error:</b><br>Language "Python" does not know how to generate code for <b>JS-only blocks.</b>';
    document.getElementById('textpy').innerHTML = error;
  } 
  try {
      var py = Blockly.Dart.workspaceToCode(workspace);
      var spli = py.replaceAll("  ","&nbsp;&nbsp;&nbsp;").split("\n");
      document.getElementById('textdart').innerHTML = "";
      for (var i =0; i < spli.length; i++) document.getElementById('textdart').innerHTML += spli[i] + "<br>";
  } catch (error) {
    if (error.toString().indexOf('does not know how to generate code for block type "js_') != -1)
        error = '<b>Error:</b><br>Language "Dart" does not know how to generate code for <b>JS-only blocks.</b>';
    document.getElementById('textdart').innerHTML = error;
  } 
  w3CodeColor();
}
workspace.addChangeListener(myUpdateFunction);

function runC() {
    removeAllChildNodes(document.getElementById('output'));
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    eval(code);
}

function runI() {
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    var myInterpreter = new Interpreter(code);
    myInterpreter.run();
}

function openCity(evt, cityName) {
  var i, x, tablinks;
  x = document.getElementsByClassName("city");
  for (i = 0; i < x.length; i++) {
    x[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablink");
  for (i = 0; i < x.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" w3-gblack", "");
  }
  document.getElementById(cityName).style.display = "block";
  evt.currentTarget.className += " w3-gblack";
}

function downloadP(name) {
    var xmlText = Blockly.Xml.domToPrettyText( Blockly.Xml.workspaceToDom(workspace) );
    download(name + ".xml", "<!-- Copyright (C) 2021 by Isaiah -->\n" + xmlText);
}

var pId;

function saveB() {
  if (undefined == pId) {
    saveBlocks();
    return;
  }
  var xmlText = Blockly.Xml.domToPrettyText( Blockly.Xml.workspaceToDom(workspace) );  
  localStorage.setItem(pId, xmlText);
  window.alert('Saved project with ID: ' + pId);
}

function saveBlocks(name) {
  var xmlText = Blockly.Xml.domToPrettyText( Blockly.Xml.workspaceToDom(workspace) );  
  if (name != null) {
    localStorage.setItem(name, xmlText);
    return;
  }
  var person = prompt("Enter ID to Save As.", pId);
  if (person != null) {
    localStorage.setItem(person, xmlText);
    console.log(localStorage.getItem(person));
  }
}

var queryString = window.location.search;
var urlParams = new URLSearchParams(queryString);
if (queryString.indexOf("projectId") != -1) {
    pId = urlParams.get("projectId")
    loadBlock(localStorage.getItem(pId));
    console.log(pId);
}


function loadBlock(xml) { // xml is the same block xml you stored
  if (typeof xml != "string" || xml.length < 5) return false;
  try {
    var dom = Blockly.Xml.textToDom(xml);
    workspace.clear();
    Blockly.Xml.domToWorkspace(dom, workspace);
    return true;
  } catch (e){return false;}
}

function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);
  element.style.display = 'none';
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}

document.getElementById('files').addEventListener('change', getFile);


function getFile(event) {
	const input = event.target
  if ('files' in input && input.files.length > 0) {
	  placeFileContent(document.getElementById('content-target'),
      input.files[0])
  }
}

function placeFileContent(target, file) {
	readFileContent(file).then(content => {
        loadBlock(content);
    }).catch(error => console.log(error))
}

function readFileContent(file) {
	const reader = new FileReader()
  return new Promise((resolve, reject) => {
    reader.onload = event => resolve(event.target.result)
    reader.onerror = error => reject(error)
    reader.readAsText(file)
  })
}

function removeAllChildNodes(parent) {
    while (parent.firstChild) {
        parent.removeChild(parent.firstChild);
    }
}

function helper_createElement(type, id) {
   var btn = document.createElement(type);
   btn.setAttribute("id", id);
   document.getElementById('output').appendChild(btn);
}
</script>
</html>